/*
 * PART1_asm.c
 *
 * This program implements the lowpass, bandpass, and high pass filters for Lab6
 * using the assembly subroutine FIRFilter2.
 * To switch between filters, simply comment out the undesired filters in the main routine.
 *
 */
#include<DSP28x_Project.h>
#include<EEL4511.h>
#include "Filters.h"

#pragma DATA_SECTION( audio_buffer , "ChipMEM" )

void Init_Timer1(void);

//volatile circBuff_f audio = { ( BUFFER_SIZE - 1 ) , 0 , {0} };
float audio_buffer[BUFFER_SIZE] = {0};
int16 audio_head = BUFFER_SIZE-1;
volatile float outputF = 0.0;
volatile Uint16 output16 = 0;
volatile Uint16 state = 0;

Filter LPF = { 0, {-0.000636,
		-0.000307,
		-0.000262,
		-0.000086,
		0.000273,
		0.000877,
		0.001788,
		0.003065,
		0.004762,
		0.006922,
		0.009571,
		0.012715,
		0.016337,
		0.020392,
		0.024811,
		0.029497,
		0.034331,
		0.039177,
		0.043884,
		0.048294,
		0.052255,
		0.055622,
		0.058268,
		0.060092,
		0.061022,
		0.061022,
		0.060092,
		0.058268,
		0.055622,
		0.052255,
		0.048294,
		0.043884,
		0.039177,
		0.034331,
		0.029497,
		0.024811,
		0.020392,
		0.016337,
		0.012715,
		0.009571,
		0.006922,
		0.004762,
		0.003065,
		0.001788,
		0.000877,
		0.000273,
		-0.000086,
		-0.000262,
		-0.000307,
		-0.000636}};

Filter HPF = { 0, {
		-0.015358,
		0.041490,
		0.001414,
		-0.011652,
		-0.014997,
		-0.014570,
		-0.012094,
		-0.007750,
		-0.001790,
		0.005506,
		0.013226,
		0.019988,
		0.024390,
		0.024781,
		0.019973,
		0.009371,
		-0.006894,
		-0.028009,
		-0.052130,
		-0.077054,
		-0.100130,
		-0.118834,
		-0.130971,
		0.864784,
		-0.130971,
		-0.118834,
		-0.100130,
		-0.077054,
		-0.052130,
		-0.028009,
		-0.006894,
		0.009371,
		0.019973,
		0.024781,
		0.024390,
		0.019988,
		0.013226,
		0.005506,
		-0.001790,
		-0.007750,
		-0.012094,
		-0.014570,
		-0.014997,
		-0.011652,
		0.001414,
		0.041490,
		-0.015358}};

Filter BPF = { 0, {0.007820,
		0.001644,
		0.001805,
		0.001968,
		0.002133,
		0.002298,
		0.002462,
		0.002620,
		0.002772,
		0.002912,
		0.003042,
		0.003161,
		0.003268,
		0.003347,
		0.003392,
		0.003431,
		0.003422,
		0.003388,
		0.003314,
		0.003203,
		0.003046,
		0.002845,
		0.002596,
		0.002300,
		0.001954,
		0.001555,
		0.001102,
		0.000601,
		0.000048,
		-0.000557,
		-0.001205,
		-0.001900,
		-0.002634,
		-0.003405,
		-0.004208,
		-0.005036,
		-0.005883,
		-0.006744,
		-0.007611,
		-0.008476,
		-0.009331,
		-0.010169,
		-0.010980,
		-0.011755,
		-0.012488,
		-0.013168,
		-0.013788,
		-0.014338,
		-0.014813,
		-0.015203,
		-0.015503,
		-0.015706,
		-0.015806,
		-0.015799,
		-0.015682,
		-0.015449,
		-0.015101,
		-0.014636,
		-0.014054,
		-0.013356,
		-0.012544,
		-0.011622,
		-0.010593,
		-0.009463,
		-0.008238,
		-0.006925,
		-0.005533,
		-0.004069,
		-0.002543,
		-0.000967,
		0.000650,
		0.002296,
		0.003960,
		0.005629,
		0.007291,
		0.008935,
		0.010547,
		0.012116,
		0.013631,
		0.015078,
		0.016449,
		0.017731,
		0.018915,
		0.019992,
		0.020954,
		0.021793,
		0.022502,
		0.023076,
		0.023510,
		0.023802,
		0.023948,
		0.023948,
		0.023802,
		0.023510,
		0.023076,
		0.022502,
		0.021793,
		0.020954,
		0.019992,
		0.018915,
		0.017731,
		0.016449,
		0.015078,
		0.013631,
		0.012116,
		0.010547,
		0.008935,
		0.007291,
		0.005629,
		0.003960,
		0.002296,
		0.000650,
		-0.000967,
		-0.002543,
		-0.004069,
		-0.005533,
		-0.006925,
		-0.008238,
		-0.009463,
		-0.010593,
		-0.011622,
		-0.012544,
		-0.013356,
		-0.014054,
		-0.014636,
		-0.015101,
		-0.015449,
		-0.015682,
		-0.015799,
		-0.015806,
		-0.015706,
		-0.015503,
		-0.015203,
		-0.014813,
		-0.014338,
		-0.013788,
		-0.013168,
		-0.012488,
		-0.011755,
		-0.010980,
		-0.010169,
		-0.009331,
		-0.008476,
		-0.007611,
		-0.006744,
		-0.005883,
		-0.005036,
		-0.004208,
		-0.003405,
		-0.002634,
		-0.001900,
		-0.001205,
		-0.000557,
		0.000048,
		0.000601,
		0.001102,
		0.001555,
		0.001954,
		0.002300,
		0.002596,
		0.002845,
		0.003046,
		0.003203,
		0.003314,
		0.003388,
		0.003422,
		0.003431,
		0.003392,
		0.003347,
		0.003268,
		0.003161,
		0.003042,
		0.002912,
		0.002772,
		0.002620,
		0.002462,
		0.002298,
		0.002133,
		0.001968,
		0.001805,
		0.001644,
		0.007820}};



interrupt void DAC_ISR()
{
	//store ADC value
		audio_buffer[audio_head] = (float) ((int) ADC_in() - 0x7FFF);
		audio_head = ( ( audio_head - 1 ) & (BUFFER_SIZE - 1) );
		state = 1;


	GpioDataRegs.GPADAT.bit.GPIO0 ^= 1;
	CpuTimer1Regs.TCR.bit.TIF = 1;
}

int main(void) {

	DisableDog();

	//150MHz
	InitPll(10,3);

	//Init_SRAM();
	Init_McBSPb_ADC();
	Init_McBSPa_DAC();
	Init_LED();

	Init_Timer1();

	while(1){
		if(state == 1)
		{
			GpioDataRegs.GPADAT.bit.GPIO1 ^= 1;
			output16 = 0;

			//output16 = (Uint16) ( (int16) FIRFilter2( &audio_buffer[0], audio_head, &LPF.coeff[0], 50) );
			//output16 = (Uint16) ( (int16) FIRFilter2( &audio_buffer[0], audio_head, &HPF.coeff[0], 47) );
			output16 = (Uint16) ( (int16) FIRFilter2( &audio_buffer[0], audio_head, &BPF.coeff[0], 182) );

			GpioDataRegs.GPADAT.bit.GPIO1 ^= 1;
			DAC_out(output16);
			state = 0;
		}

	}

}

void Init_Timer1(void)
{
	EALLOW;
	InitCpuTimers();

	ConfigCpuTimer( &CpuTimer1 , 150 , 20);

	PieVectTable.XINT13 = DAC_ISR;
	PieCtrlRegs.PIECTRL.bit.ENPIE = 1;

	IER |= M_INT13;

	EINT;

	StartCpuTimer1();

}
